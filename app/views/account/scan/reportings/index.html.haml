- months = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"]

#reporting.container.padding4top
  - if current_user.is_prescriber || current_user.is_admin
    .row
      .span12
        .actionbar.well
          - if current_user.is_admin?
            .row.margin1bottom
              .span11
                %form.margin0bottom{ :action => account_scan_reportings_path, :method => "GET" }
                  = label_tag :email, "Voir le reporting de :", :class => "pull-left margin1right margin0bottom"
                  = text_field_tag :email, "", :class => "pull-left margin1right margin0bottom", :style => "width:200px;height:13px;font-size:11px;", :value => params[:email] ||= ""
                  = submit_tag "Valider", :class => "btn margin1right margin0bottom", :style => "height:23px;padding-top:2px;font-size:11px;"
            %hr.margin1top.margin1bottom
          .row
            .span3
              %table
                %tr{ :style => "text-align:left;" }
                  %th= label_tag :value_filter, "Afficher : "
                %tr
                  %td= select_tag(:value_filter, options_for_select( [["Feuilles",0],["Pièces",1],["Pages",2],["Feuilles téléversées",3],["Pièces téléversées",4],["Pages téléversées",5],["Attaches",6],["Hors format",7],["Total",8]] ), :class => "margin0bottom", :style => "width:auto;")
            .span8
              %form#filter.margin0bottom
                %table
                  %tr{ :style => "text-align:left;" }
                    %th= label_tag :user_filter, "Utilisateur : ", :class => "margin1left"
                    %th= label_tag :account_book_filter, "Journal : "
                    %th= label_tag :year_filter, "Année : "
                    %th= label_tag :month_filter, "Mois : "
                    %th
                    %th
                  %tr
                    %td= select_tag(:user_filter, options_for_select( [["Tous",0]] + filter_list_of_users(@users) ), :class => "margin1left margin0bottom", :style => "width:auto")
                    %td= text_field_tag :account_book_filter, "", :class => "margin0bottom", :style => "width:50px;height:13px;font-size:11px;"
                    %td= text_field_tag :year_filter, "", :class => "margin0bottom", :style => "width:50px;height:13px;font-size:11px;"
                    %td= text_field_tag :month_filter, "", :class => "margin0bottom", :style => "width:50px;height:13px;font-size:11px;"
                    %td= submit_tag "ok", :class => "btn margin0bottom", :style => "height:23px;font-size:11px;padding:2px 10px 4px;"
                    %td#filter_results.padding1left{ :style => "color:green;" }
  
  - annual_summary = []
  - 12.times do
    - annual_summary << { :pieces => 0, :sheets => 0, :pages => 0, :uploaded_pieces => 0, :uploaded_sheets => 0, :uploaded_pages => 0, :paperclips => 0, :oversized => 0, :price_in_cents => 0 }
  
  .row
    .span12
      %table.table.table-condensed
        %thead
          %tr
            %th{ :style => "width:15%;" }
              Utilisateur
            - months.each do |month|
              %th{ :style => "width:7%;text-align:center;" }
                #{month}
        %tbody
          - @users.each do |user|
            %tr{ :id => "user_#{user.id}", :class => "user" }
              %td
                #{[user.code,user.company].join(" - ")}
              - periods = annual_periods_for_user(user, @subscriptions, @year)
              - periods.each do |period|
                - if period
                  %td{ :style => "width:7%;text-align:center;", :colspan => period.duration }
                    %a.do-show{ "href" => "#", :id => "refs_#{user.id}_#{period.id}_#{period.start_at.month}_#{period.duration}" }
                      .period{ :class => "user_id_#{user.id} period_id_#{period.id} n_#{period.start_at.month}" }
                        - if period.delivery.state == "wait"
                          %span.badge.badge-important.pull-left{ :style => "height:16px;padding:2px 3px 1px;width:10px;", :rel => "tooltip", :title => "Attendus" }
                            A
                        - elsif period.delivery.state == "received"
                          %span.badge.badge-warning.pull-left{ :style => "height:16px;padding:2px 3px 1px;width:10px;", :rel => "tooltip", :title => "Reçus" }
                            R
                        - elsif period.delivery.state == "delivered"
                          %span.badge.badge-info.pull-left{ :style => "height:16px;padding:2px 3px 1px;width:10px;", :rel => "tooltip", :title => "Traités" }
                            T
                        %span{ :class => period.documents_name_tags }
                        .value
                          %span{ :class => "hide pieces value_1" }
                            #{period.pieces}
                          %span{ :class => "sheets value_0" }
                            #{period.sheets}
                          %span{ :class => "hide pages value_2" }
                            #{period.pages}
                          %span{ :class => "hide uploaded_pieces value_4" }
                            #{period.uploaded_pieces}
                          %span{ :class => "hide uploaded_sheets value_3" }
                            #{period.uploaded_sheets}
                          %span{ :class => "hide uploaded_pages value_5" }
                            #{period.uploaded_pages}
                          %span{ :class => "hide paperclips value_6" }
                            #{period.paperclips}
                          %span{ :class => "hide oversized value_7" }
                            #{period.oversized}
                          %span{ :class => "hide price value_8" }
                            #{format_price_00 period.price_in_cents_w_vat} €
                            
                          - annual_summary[period.end_at.month - 1][:pieces] += period.pieces
                          - annual_summary[period.end_at.month - 1][:sheets] += period.sheets
                          - annual_summary[period.end_at.month - 1][:pages] += period.pages
                          - annual_summary[period.end_at.month - 1][:uploaded_pieces] += period.uploaded_pieces
                          - annual_summary[period.end_at.month - 1][:uploaded_sheets] += period.uploaded_sheets
                          - annual_summary[period.end_at.month - 1][:uploaded_pages] += period.uploaded_pages
                          - annual_summary[period.end_at.month - 1][:paperclips] += period.paperclips
                          - annual_summary[period.end_at.month - 1][:oversized] += period.oversized
                          - annual_summary[period.end_at.month - 1][:price_in_cents] += period.price_in_cents_w_vat
                - else
                  %td{ :style => "width:7%;text-align:center;" }
                    \-
          - if current_user.is_prescriber || current_user.is_admin
            %tr#total
              %td
                %b Total
              - annual_summary.each do |month|
                %td{ :style => "width:7%;text-align:center;" }
                  %b.value
                    %span{ :class => "hide pieces value_1" }
                      #{month[:pieces]}
                    %span{ :class => "sheets value_0" }
                      #{month[:sheets]}
                    %span{ :class => "hide pages value_2" }
                      #{month[:pages]}
                    %span{ :class => "hide uploaded_pieces value_4" }
                      #{month[:uploaded_pieces]}
                    %span{ :class => "hide uploaded_sheets value_3" }
                      #{month[:uploaded_sheets]}
                    %span{ :class => "hide uploaded_pages value_5" }
                      #{month[:uploaded_pages]}
                    %span{ :class => "hide paperclips value_6" }
                      #{month[:paperclips]}
                    %span{ :class => "hide oversized value_7" }
                      #{month[:oversized]}
                    %span{ :class => "hide price value_8" }
                      #{format_price_00 month[:price_in_cents]} €

.modal.fade{ :id=>"periodModal" }
  .modal-header
    %a{ :class=>"close", "data-dismiss"=>"modal" } ×
    %h3.title_period{ :style => "text-align:center;" }
    = hidden_field_tag :year, @year
  .modal-body
  .modal-footer
    %a.btn.prev.do-show.margin3left{ :style => "float:left;margin-left:0;" }
      précédent
    %a.btn.next.do-show{ :style => "float:right;" }
      suivant

:plain
  <script type="text/x-tmpl" id="tmpl-period">
    <div class="documentslist">
      <table class="table table-striped table-condensed">
        <tr>
          <th>Nom des documents</th>
          <th class="center">Pièces</th>
          <th class="center">Feuilles</th>
          <th class="center">Pages</th>
          <th class="center">Attaches</th>
          <th class="center">Hors format</th>
        </tr>
        {% for(var i=0; i<o.documents.list.length; i++) { %}
          <tr>
            <td><a href="{%= o.documents.list[i].link%}">{%= o.documents.list[i].name %}</a></td>
            <td class="center">{%= o.documents.list[i].pieces %} ({%= (parseInt(o.documents.list[i].pieces) - parseInt(o.documents.list[i].uploaded_pieces)+'') %}, {%= o.documents.list[i].uploaded_pieces %})</td>
            <td class="center">{%= (parseInt(o.documents.list[i].sheets) - parseInt(o.documents.list[i].uploaded_sheets))+'' %}</td>
            <td class="center">{%= o.documents.list[i].pages %} ({%= (parseInt(o.documents.list[i].pages) - parseInt(o.documents.list[i].uploaded_pages))+'' %}, {%= o.documents.list[i].uploaded_pages %})</td>
            <td class="center">{%= o.documents.list[i].paperclips %}</td>
            <td class="center">{%= o.documents.list[i].oversized %}</td>
          </tr>
        {% } %}
        <tr>
          <td><b>Total</b></td>
          <td class="center">{%= o.documents.total.pieces %} ({%= (parseInt(o.documents.total.pieces) - parseInt(o.documents.total.uploaded_pieces))+'' %}, {%= o.documents.total.uploaded_pieces %})</td>
          <td class="center">{%= (parseInt(o.documents.total.sheets) - parseInt(o.documents.total.uploaded_sheets))+'' %}</td>
          <td class="center">{%= o.documents.total.pages %} ({%= (parseInt(o.documents.total.pages) - parseInt(o.documents.total.uploaded_pages))+'' %}, {%= o.documents.total.uploaded_pages %})</td>
          <td class="center">{%= o.documents.total.paperclips %}</td>
          <td class="center">{%= o.documents.total.oversized %}</td>
        </tr>
        <tr>
          <td><b>Dépassement</b></td>
          <td></td>
          <td class="center">{%= o.documents.excess.sheets %}</td>
          <td class="center">{%= o.documents.excess.uploaded_pages %}</td>
          <td></td>
          <td></td>
        </tr>
      </table>
    </div>
    <div class="optionslist">
      <table class="table table-striped table-condensed">
        <tr>
          <th>Paramètre</th>
          <th>Valeur</th>
          <th style="text-align:right;">Prix HT</th>
        </tr>
        {% for(var i=0; i<o.options.list.length; i++) { %}
          <tr>
            <td>{%# o.options.list[i].group_title %}</td>
            <td>{%# o.options.list[i].title %}</td>
            <td style="text-align:right;">{%= o.options.list[i].price %} €</td>
          </tr>
        {% } %}
        <tr>
          <td>Dépassement</td>
          <td></td>
          <td style="text-align:right;">{%= o.options.excess_price%} €</td>
        </tr>
        <tr>
          <td></td>
          <td>Total :</td>
          <td style="text-align:right;">{%= o.options.total%} €</td>
        </tr>
        <tr>
          <td></td>
          <td>Facture :</td>
          <td>{%= o.options.invoice_link%}</td>
        </tr>
    </div>
  </script>
  


:css
  .period{
    border: 1px solid #BBBBBB;
    margin: 0;
    padding:1px 3px 2px;
    font-size:9px;
    font-weight:bold;
    color:#ffffff;
    text-transform:uppercase;
    background-color:#BBBBBB;
    -webkit-border-radius:3px;
    -moz-border-radius:3px;
    border-radius:3px;}
  .period:hover{
    border: 1px solid #999999;
    background-color:#999999;}
  .period.selected{
    border:1px solid green;}
  .period table td{
    height:10px;
    font-size:8px;}
    
  #periodModal{
    margin:-310px 0 0 -500px;
    height:464px;
    width:1000px; }
  #periodModal .modal-body{
    height:330px; }
  #periodModal .documentslist{
    height:330px;
    width:500px;
    float:left; }
  #periodModal .optionslist{
    height:330px;
    width:400px;
    float:right; }
    
  #periodModal table tr td.center, #periodModal table tr th.center{
    text-align:center; }