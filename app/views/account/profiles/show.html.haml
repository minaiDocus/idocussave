.container-fluid
  .alerts
    = render partial: 'shared/messages'

  .row-fluid
    .span3
      .row-fluid
        .span12
          = render partial: 'layouts/account/me/navigation'

    .span9
      - unless @user.try(:organization).try(:is_suspended) && @user.active?
        #change_password.row-fluid.pan{ class: (@active_panel == 'change_password' ? 'active' : '')}
          .span12
            .well.change_pass_parent
              %h3.aligncenter Changer mon mot de passe
              %br/
              .change_pass
                = form_for @user, :url => account_profile_path do |f|
                  - if flash[:alert].present?
                    .alert-container
                      .alert.alert-error
                        %a{ :class=>"close", "data-dismiss"=>"alert" } ×
                        %span
                          %ul
                            %li
                              Mots de passe invalides

                  != f.label "Mot de passe actuel :"
                  = f.password_field :current_password, :label => "Ancien mot de passe"
                  != f.label "Nouveau mot de passe :"
                  = f.password_field :password, :label => "Nouveau mot de passe"
                  != f.label "Confirmation du mot de passe :"
                  = f.password_field :password_confirmation, :label => "Confirmation du nouveau mot de passe"
                  != f.submit "Modifier", :class => "btn blue"

        - if @user.active? && !@user.is_prescriber && @user.organization.is_active
          #account_sharing.row-fluid.pan{ class: (@active_panel == 'account_sharing' ? 'active' : '')}
            .span12.well
              .row-fluid
                .span12
                  %h3.aligncenter Partage de compte
              - unless @user.is_guest
                %h4 Liste des contacts avec qui je partage mon compte :
                %ul
                  - if @user.inverse_account_sharings.size > 0
                    - @user.inverse_account_sharings.each do |account_sharing|
                      %li
                        = account_sharing.collaborator.info
                        = link_to icon_destroy, account_account_sharing_path(account_sharing), method: :delete, data: { confirm: "Êtes-vous sûr de vouloir annuler le partage de votre compte avec \"#{account_sharing.collaborator.info}\" ?" }
                  - else
                    %li
                      %i{ style: 'color:gray' } Aucun
                = link_to 'Partager mon compte avec un contact', new_account_account_sharing_path, class: 'btn btn-primary'
                %br
                %br
              %h4 Liste des dossiers qui me sont partagés :
              %ul
                - if @user.account_sharings.size > 0
                  - @user.account_sharings.each do |account_sharing|
                    %li
                      = account_sharing.account.info
                      = link_to icon_destroy, account_account_sharing_path(account_sharing), method: :delete, data: { confirm: "Êtes-vous sûr de ne plus vouloir accéder au dossier \"#{account_sharing.account.info}\" ?" }
                - else
                  %li
                    %i{ style: 'color:gray' } Aucun
              %h4 Liste des mes demandes d'accès :
              %ul
                - if @user.account_sharings.pending.select { |e| e.collaborator == @user }.size > 0
                  - @user.account_sharings.pending.select { |e| e.collaborator == @user }.each do |account_sharing|
                    %li
                      = account_sharing.account.info
                      = link_to icon_destroy, account_account_sharing_path(account_sharing), method: :delete, data: { confirm: "Êtes-vous sûr de ne plus vouloir accéder au dossier \"#{account_sharing.account.info}\" ?" }
                - else
                  %li
                    %i{ style: 'color:gray' } Aucun
              = link_to "Demander l'accès à un dossier", new_request_account_account_sharings_path, class: 'btn btn-primary'

          - unless @user.is_guest
            #addresses_management.row-fluid.pan{ class: (@active_panel == 'addresses_management' ? 'active' : '')}
              .span12.well
                .row-fluid
                  .span12
                    %h3.aligncenter Gestion des adresses
                %br
                .row-fluid
                  .span4
                    = render partial: 'account/addresses/address', locals: { address: @user.paper_return_address, single: true, type: 'paper_return' }
                  .span4
                    = render partial: 'account/addresses/address', locals: { address: @user.paper_set_shipping_address, single: true, type: 'paper_set_shipping' }
                  .span4
                    = render partial: 'account/addresses/address', locals: { address: @user.dematbox_shipping_address, single: true, type: 'dematbox_shipping' }
                .row-fluid
                  .span12.aligncenter.margin1top
                    = link_to 'Configurer', account_addresses_path, class: 'btn'

      - if @user.active?
        -if @user.organization.is_active
          - unless @user.try(:organization).try(:is_suspended)
            #efs_management.row-fluid.pan{ class: (@active_panel == 'efs_management' ? 'active' : '')}
              .span12.well
                %h3.aligncenter Stockage externe des documents
                Configurer l’accès à vos services de stockage externe de documents vous permet de recevoir tous les documents numérisés par iDocus sur un autre support que notre plateforme (Export de documents). Nous pouvons également aller chercher les documents directement sur ces supports externes (Import de documents)
                %br
                - if @external_file_storage.authorized > 0
                  %br
                  - if @external_file_storage.is_dropbox_basic_authorized?
                    - service_number = ExternalFileStorage::F_DROPBOX
                    - is_service_used = @external_file_storage.is_used?(service_number)
                    #dropbox.well
                      .row-fluid
                        .span1
                          = check_box_tag :enable_dropbox, 1, is_service_used, id: "service_#{service_number}", class: 'checkbox use_service', style: 'float:left; margin-right:5px; margin-top:0;'
                          %div{ style: 'float:left; text-align:center; width:50px' }
                            %a.logo= image_tag 'application/dropbox_logo.png', :alt => 'logo'
                            %b DROPBOX
                        .span11.aligncenter{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                          - if @external_file_storage.dropbox_basic.is_configured?
                            %h5
                              Votre compte iDocus est connecté à votre compte Dropbox.
                              = link_to 'Paramètres.', authorize_url_account_dropbox_path
                          - else
                            %h5
                              Pour connecter iDocus à votre compte Dropbox,
                              = link_to ' cliquez ici.', authorize_url_account_dropbox_path
                              %br
                              iDocus va créer un premier dossier « Applications » puis « iDocus ».
                          #{"."}
                      .row-fluid{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                        .span12
                          .row-fluid
                            .span6.margin2top
                              = render partial: 'storage_form', locals: { storage: @external_file_storage.dropbox_basic }
                            .span6.margin2top
                              %h4 Import de documents vers iDocus
                              Importer automatiquement des documents depuis la Dropbox. iDocus créé un dossier « exportation vers iDocus » dans le dossier « iDocus ».
                              %br
                              Vous n’avez plus qu’à déposer vos documents dans la bonne période (période actuelle ou période précédente) et dans le bon journal comptable qui vous a été attribué.
                              %br
                              %br
                              La récupération de votre dossier d’import se fait automatiquement. Tous les documents récupérés par iDocus sont retirés du dossier.

                  - if @external_file_storage.is_google_docs_authorized?
                    - service_number = ExternalFileStorage::F_GOOGLE_DOCS
                    - is_service_used = @external_file_storage.is_used?(service_number)
                    #google_drive.well
                      .row-fluid
                        .span1
                          = check_box_tag :enable_google_docs, 1, is_service_used, id: "service_#{service_number}", class: 'checkbox use_service', style: 'float:left; margin-right:5px; margin-top:0;'
                          %div{ style: 'float:left; text-align:center; width:50px' }
                            %a.logo= image_tag 'application/googledrive_logo.png', alt: 'logo'
                            %b GOOGLE DRIVE (Beta)
                        .span11.aligncenter{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                          - if @external_file_storage.google_doc.is_configured?
                            %h5
                              Votre compte iDocus est connecté à votre compte Google Drive.
                              = link_to 'Paramètres.', authorize_url_account_google_drive_path, method: :post
                          - else
                            %h5
                              Pour connecter iDocus à votre compte Google Drive,
                              = link_to ' cliquez ici.', authorize_url_account_google_drive_path, method: :post
                          #{"."}
                      .row-fluid{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                        .span12
                          .margin2top
                            = render partial: 'storage_form', locals: { storage: @external_file_storage.google_doc }

                  - if @external_file_storage.is_ftp_authorized?
                    - service_number = ExternalFileStorage::F_FTP
                    - is_service_used = @external_file_storage.is_used?(service_number)
                    #ftp.well
                      .row-fluid
                        .span1
                          = check_box_tag :enable_ftp, 1, is_service_used, id: "service_#{service_number}", class: 'checkbox use_service', style: 'float:left; margin-right:5px; margin-top:0;'
                          %div{ style: 'float:left; text-align:center; width:50px' }
                            %a.logo= image_tag 'application/ftp_logo.png', alt: 'logo'
                            %b FTP
                        .span11.aligncenter{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                          - if @external_file_storage.ftp.is_configured?
                            %h5
                              Votre compte iDocus est connecté à votre compte FTP.
                              = link_to 'Configurer', edit_account_ftp_path
                              ou
                              = link_to 'supprimer mes paramètres.', account_ftp_path, method: :delete, data: { confirm: 'Êtes-vous sûr de vouloir supprimer vos paramètres FTP ?' }
                          - else
                            %h5
                              Pour connecter iDocus à votre compte FTP,
                              = link_to ' cliquez ici.', edit_account_ftp_path
                          \.
                      .row-fluid{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                        .span12
                          .margin2top
                            = render partial: 'storage_form', locals: { storage: @external_file_storage.ftp }

                  - if @external_file_storage.is_box_authorized?
                    - service_number = ExternalFileStorage::F_BOX
                    - is_service_used = @external_file_storage.is_used?(service_number)
                    #box.well
                      .row-fluid
                        .span1
                          = check_box_tag :enable_box, 1, is_service_used, id: "service_#{service_number}", class: 'checkbox use_service', style: 'float:left; margin-right:5px; margin-top:0;'
                          %div{ style: 'float:left; text-align:center; width:50px' }
                            %a.logo= image_tag 'application/box_logo.png', alt: 'logo'
                            %b Box.com
                        .span11.aligncenter{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                          - if @external_file_storage.box.is_configured?
                            %h5
                              Votre compte iDocus est connecté à votre compte Box.com.
                              = link_to 'Paramètres.', authorize_url_account_box_path
                          - else
                            %h5
                              Pour connecter iDocus à votre compte Box,
                              = link_to ' cliquez ici.', authorize_url_account_box_path
                          #{"."}
                      .row-fluid{ :class => "service_config_#{service_number} #{!is_service_used ? 'hide' : ''}" }
                        .span12
                          .margin2top
                            = render partial: 'storage_form', locals: { storage: @external_file_storage.box }

            - if @user.is_dematbox_authorized
              #idocus_box.row-fluid.pan{ class: (@active_panel == 'idocus_box' ? 'active' : '') }
                .span12
                  .well
                    %h3.aligncenter.margin2bottom iDocus'Box
                    - if @user.dematbox.try(:is_configured)
                      %h4.margin1bottom Liste des services
                      - if @user.dematbox.try(:services).try(:any?)
                        %table.table.table-striped.table-bordered.table-condensed.margin0bottom
                          %thead
                            %tr
                              %th Groupe
                              %th Nom
                          %tbody
                            - @user.dematbox.services.order(group_name: :asc, name: :asc).each do |service|
                              %tr
                                %td= service.group_name
                                %td= service.name
                      - elsif @user.account_book_types.size == 0
                        %p Pas de journaux paramétrés.
                      .alignright
                        = link_to icon_destroy + ' Déconnecter le Scanner', account_dematbox_path, method: :delete, class: 'btn btn-danger margin1top', data: { confirm: 'Etes-vous sûr de vouloir déconnecter le scanner ?' }
                    - elsif @user.dematbox.try(:beginning_configuration_at).present?
                      Configuration en cours...veuillez recharger votre page dans quelques secondes.
                    - else
                      Appairez ici un scanner iDocus'Box (Produit Sagemcom).
                      %br
                      Afin d'appairer le scanner, merci de suivre les instructions du
                      = link_to "mode d'emploi Sagemcom", docs_download_path(name: 'Livret_utilisation_Dematbox.pdf')
                      fournit lors de la livraison.
                      %br
                      Merci d'inscrire le code d'appairage dans le champ ci-dessous :
                      = form_tag account_dematbox_path, method: :post, class: 'form-inline margin2top' do
                        = label_tag :pairing_code, 'Code appairage'
                        = text_field_tag :pairing_code, '', style: 'width:75px;'
                        = submit_tag t('actions.submit'), class: 'btn btn-primary'

            #subscription_options.row-fluid.pan{ class: (@active_panel == 'subscription_options' ? 'active' : '')}
              .span12
                .well
                  %h3.aligncenter.margin2bottom Notifications et remontées d'alertes
                  = simple_form_for @user, url: account_profile_path, html: { id: 'subscription_options' } do |f|
                    = f.simple_fields_for :notify do |o|
                      %h4.margin2left.margin1bottom Générale
                      = hidden_field_tag :panel, 'subscription_options'
                      - if @user.options.try(:is_upload_authorized) && !@user.is_prescriber
                        = o.input :to_send_docs, as: :boolean, label: "oui, je veux recevoir des mails de relance pour ne pas oublier d'envoyer mes documents à numériser.", wrapper: :inline_checkbox
                      = o.input :published_docs, label: 'Lorsque de nouveaux documents sont disponibles', collection: notification_options, include_blank: false, label_html: { class: 'notification_options_label' }
                      - if @user.options.try(:is_upload_authorized) && !@user.is_prescriber
                        = o.input :reception_of_emailed_docs, as: :boolean, label: "oui, je veux recevoir un mail de confirmation lorsque la plateforme reçoit avec succès un document que j’ai envoyé par mail.", wrapper: :inline_checkbox
                      - if @user.options.try(:is_upload_authorized) || @user.options.try(:is_dematbox_authorized) || @user.is_prescriber
                        = o.input :document_being_processed, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsque des documents sont en cours de traitement.", wrapper: :inline_checkbox
                      - if !@user.is_prescriber && (@user.subscription.is_mail_package_active || @user.subscription.is_annual_package_active)
                        = o.input :paper_quota_reached, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsque mon quota de 100 feuilles par période a été atteint.", wrapper: :inline_checkbox
                      - if @user.is_prescriber
                        = o.input :new_pre_assignment_available, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsque de nouvelles pré-affectations sont disponibles.", wrapper: :inline_checkbox
                      %hr
                      %h4.margin2left.margin1bottom Doublons de pré-affectation
                      = o.input :detected_preseizure_duplication, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsque des doublons de pré-affectation sont bloqués.", wrapper: :inline_checkbox
                      %hr
                      %h4.margin2left.margin1bottom Livraison Dropbox
                      = o.input :dropbox_invalid_access_token, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsque mon compte Dropbox est déconnecté.", wrapper: :inline_checkbox
                      = o.input :dropbox_insufficient_space, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsque mon compte Dropbox n'a plus d'espace.", wrapper: :inline_checkbox
                      %hr
                      %h4.margin2left.margin1bottom
                        - if @user.is_prescriber
                          Import/Export FTP
                        - else
                          Livraison FTP
                      = o.input :ftp_auth_failure, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsque mon FTP est déconnecté.", wrapper: :inline_checkbox
                      - if @user.options.try(:is_retriever_authorized) || @user.is_prescriber
                        %hr
                        %h4.margin2left.margin1bottom Automate
                        = o.input :r_wrong_pass, as: :boolean, label: "oui, je veux recevoir une notification lorsqu'un mot de passe est invalide pour un automate.", wrapper: :inline_checkbox
                        = o.input :r_site_unavailable, as: :boolean, label: "oui, je veux recevoir une notification lorsqu'un site web est indisponible pour un automate.", wrapper: :inline_checkbox
                        = o.input :r_action_needed, as: :boolean, label: "oui, je veux recevoir des mails de notification lorsqu'une action est nécessaire pour un automate.", wrapper: :inline_checkbox
                        = o.input :r_bug, as: :boolean, label: "oui, je veux recevoir une notification lorsqu'un automate ne fonctionne pas.", wrapper: :inline_checkbox
                        - if @user.is_prescriber
                          = o.input :r_no_bank_account_configured, as: :boolean, label: "oui, je veux recevoir une notification lorsque aucun compte bancaire n'est configuré pour un automate bancaire.", wrapper: :inline_checkbox
                        = o.input :r_new_documents, label: 'Lorsque de nouveaux documents sont disponibles', collection: notification_options, include_blank: false, label_html: { class: 'notification_options_label' }
                        = o.input :r_new_operations, label: 'Lorsque de nouvelles opérations sont disponibles', collection: notification_options, include_blank: false, label_html: { class: 'notification_options_label' }
                    .form-actions.padding0bottom
                      = f.submit 'Valider', class: 'btn btn-primary'

            - if @user.options.try(:is_upload_authorized) && !(@user.is_admin || @user.is_prescriber || @user.inactive?)
              - period_service = PeriodService.new user: @user, current_time: Time.now.beginning_of_month
              #emailed_documents.row-fluid.pan{ class: (@active_panel == 'emailed_documents' ? 'active' : '')}
                .span12
                  .well
                    %h3.aligncenter Adresse email d'envoi de documents
                    %br
                    Vous pouvez envoyer vos pièces comptables par mail.
                    %br
                    La plateforme iDocus intégrera les pièces jointes (#{UploadedDocument.valid_extensions}) de votre mail.
                    %br
                    %br
                    Règles d'utilisation :
                    %ul
                      %li
                        Format de l’objet du mail : [libellé court du journal comptable] [période]
                        - if @user.account_book_types.first && period_service.names.first
                          %br
                          exemple :
                          %b
                            %i #{@user.account_book_types.first.name} #{period_service.names.first}
                      %li
                        La somme des tailles des pièces jointes de votre mail ne doit pas dépasser
                        %b 10 Mo
                        \.
                    Vos journaux comptables accessibles :
                    %ul
                      - @user.account_book_types.each do |journal|
                        %li
                          %b= journal.name
                          = "(#{journal.description.sub(/\A\s*\(/,'').sub(/\)\s*\z/,'')})"
                    Vos périodes actuellement accessibles :
                    %ul
                      - period_service.names.each do |name|
                        %li
                          %b= name
                    Voici votre adresse personnalisée à laquelle vous devez envoyer vos pièces :
                    %b{ style: 'font-size: 16px;' }
                      = "#{@user.email_code}@fw.idocus.com"
                    = link_to 'Générer une nouvelle adresse', regenerate_code_account_emailed_documents_path, class: 'btn btn-mini btn-primary', data: { method: :post }, style: 'position:relative;top:-2px;'

        -if !@user.organization.is_active && @user == @user.organization.leader
          #active_organization.row-fluid.pan{ class: (@active_panel == 'active_organization' ? 'active' : '')}
            .span12
              .well
                .aligncenter
                  %h3 Réactiver mon compte client
                  %br
                  Pour réactiver votre compte client veuillez envoyer un courriel à
                  = link_to 'commercial@idocus.com', 'mailto:commercial@idocus.com'

        - if @user.is_prescriber || @user.invoices.count > 0
          - unless @user.try(:organization).try(:is_suspended)
            #invoices.row-fluid.pan{ class: (@active_panel == 'invoices' ? 'active' : '')}
              .span12
                .well
                  %h3.aligncenter Factures
                  %table.table.table-bordered.table-striped
                    %thead
                      %tr
                        %th Numéro
                        %th Montant
                        %th Actions
                    %tbody
                      - @invoices.each do |invoice|
                        %tr
                          %td= invoice.number
                          %th.price
                            - if invoice.amount_in_cents_w_vat
                              = "#{format_price_00(invoice.amount_in_cents_w_vat)} €"
                          %td.actions
                            = link_to icon_show, invoice.content.url, class: 'do-showInvoice', title: "#{invoice.number}.pdf"
                            = icon_link_to invoice.content.url, { icon: 'download' }, { target: '_blank' }
                  = paginate @invoices, params: { panel: 'invoices' }
              #showInvoice.modal.hide.fade
                .modal-header
                  %a.close{ data: { dismiss: :modal } } ×
                  %h3
                .modal-body
                  %iframe{ :src => '' }


= render "help"
