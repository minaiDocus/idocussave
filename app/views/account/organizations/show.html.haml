#organization
  .row-fluid
    .span12
      - if @user.is_admin
        .row-fluid
          .span12.box
            .row-fluid
              .span6
                - if !@organization.is_active
                  %span.label.label-important.pull-left.margin1right.closed_account Compte clôturé
              .span6.alignright
                - if @organization.is_active
                  = link_to icon_not_ok + " Clôturer l'organisation", close_confirm_account_organization_path(@organization), class: 'btn btn-danger'
                - else
                  = link_to icon_not_ok + " Réouvrir l'organisation", activate_account_organization_path(@organization), method: 'patch',class: 'btn btn-primary'

      .row-fluid
        .span12.box
          %ul.nav.nav-tabs
            %li{ class: ('active' if params[:tab] == 'information' || params[:tab].blank? ) }
              %a{ href: '#information', data: { toggle: 'tab' } } Information
            -if @organization.is_active
              %li{ class: ('active' if params[:tab] == 'file_naming_policy') }
                %a{ href: '#file_naming_policy', data: { toggle: 'tab' } } Charte de nommage PDF
              %li{ class: ('active' if params[:tab] == 'addresses') }
                %a{ href: '#addresses', data: { toggle: 'tab' } } Adresses
              %li{ class: ('active' if params[:tab] == 'period_options') }
                %a{ href: '#period_options', data: { toggle: 'tab' } } Options des périodes
              %li{ class: ('active' if params[:tab] == 'reminder_emails') }
                %a{ href: '#reminder_emails', data: { toggle: 'tab' } } Emails de rappels
              - if @organization.ibiza.try(:is_configured?)
                %li{ class: ('active' if params[:tab] == 'account_number_rules') }
                  %a{ href: '#account_number_rules', data: { toggle: 'tab' } } Règles affectations bancaires
              %li{ class: ('active' if params[:tab] == 'knowings') }
                %a{ href: '#knowings', data: { toggle: 'tab' } } Knowings
            %li{ class: ('active' if params[:tab] == 'ibiza') }
              %a{ href: '#ibiza', data: { toggle: 'tab' } } iBiza
            %li{ class: ('active' if params[:tab] == 'other_software') }
              %a{ href: '#other_software', data: { toggle: 'tab' } } Autres logiciels
            - if @organization.is_csv_descriptor_used
              %li{ class: ('active' if params[:tab] == 'csv_descriptor') }
                %a{ href: '#csv_descriptor', data: { toggle: 'tab' } } Format d’export .csv
            - if @user.is_admin
              %li{ class: ('active' if params[:tab] == 'file_sending_kit') }
                %a{ href: '#file_sending_kit', data: { toggle: 'tab' } } Kit d'envoi de documents
              %li{ class: ('active' if params[:tab] == 'subscription') }
                %a{ href: '#subscription', data: { toggle: 'tab' } } Abonnement

          .tab-content
            #information.tab-pane{ class: ('active' if params[:tab] == 'information' || params[:tab].blank?) }
              .row-fluid
                .span8
                  %table.table.table-condensed.table-striped
                    %tr
                      %th= t('mongoid.models.organization.attributes.name')
                      %td= @organization.name
                    %tr
                      %th= t('mongoid.models.organization.attributes.code')
                      %td= @organization.code
                    %tr
                      %th= t('mongoid.models.organization.attributes.leader')
                      %td= @organization.leader.try(:info)
                    %tr
                      %th= t('mongoid.models.organization.attributes.is_journals_management_centralized')
                      %td= @organization.is_journals_management_centralized ? t('yes_value') : t('no_value')
                    %tr
                      %th= t('mongoid.models.organization.attributes.is_detail_authorized')
                      %td= @organization.is_detail_authorized ? t('yes_value') : t('no_value')
                    %tr
                      %th= t('mongoid.models.organization.attributes.is_pre_assignment_date_computed')
                      %td= @organization.is_pre_assignment_date_computed ? t('yes_value') : t('no_value')
                .span4
                  %table.table.table-condensed.table-striped
                    %tr
                      %th= t('mongoid.models.organization.attributes.collaborators_count')
                      - if is_leader?
                        %td= link_to @organization.collaborators.count, account_organization_collaborators_path(@organization)
                      - else
                        %td= @organization.collaborators.count
                    %tr
                      %th= t('mongoid.models.organization.attributes.customers_count')
                      %td= link_to @organization.customers.count, account_organization_customers_path(@organization)
                    %tr
                      %th= t('mongoid.models.organization.attributes.centralized_customers_count')
                      %td= @organization.customers.centralized.count
                    %tr
                      %th Nombre de clients actifs
                      %td= @organization.customers.active.count
                    %tr
                      %th Nombre de clients actifs et centralisés
                      %td= @organization.customers.active.centralized.count
              - if is_leader?
                .row-fluid
                  .span12= link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_path(@organization), class: 'btn btn-primary'
            #file_naming_policy.tab-pane{ class: ('active' if params[:tab] == 'file_naming_policy') }
              %p Configuration actuelle du nom de vos fichiers en sortie vers les stockages externes.
              %table.table.table-condensed.table-striped
                %tbody
                  %tr
                    %th= t('mongoid.models.file_naming_policy.attributes.scope')
                    %td
                      - if @organization.foc_file_naming_policy.scope == 'organization'
                        collaborateurs et clients
                      - else
                        collaborateurs uniquement
                  %tr
                    %th Exemple
                    %td= CustomFileNameService.new(@organization.foc_file_naming_policy).execute({'user_code' => 'TS%00001', 'user_company' => 'iDocus', 'journal' => 'AC', 'period' => '201501', 'piece_number' => '001', 'third_party' => 'Google', 'invoice_number' => '001002', 'invoice_date' => '2015-01-02', 'extension' => '.pdf'})
              - if is_leader?
                .alignright= link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_file_naming_policy_path(@organization), class: 'btn btn-primary'
            #addresses.tab-pane{ class: ('active' if params[:tab] == 'addresses') }
              .row-fluid.margin1bottom
                .span4= render partial: 'account/organization_addresses/address', locals: { address: @organization.billing_address,  single: true, type: 'billing' }
                .span4= render partial: 'account/organization_addresses/address', locals: { address: @organization.shipping_address, single: true, type: 'shipping' }
                .span4= render partial: 'account/organization_addresses/address', locals: { address: @organization.kit_shipping_address, single: true, type: 'kit_shipping' }
              .row-fluid
                .span12.aligncenter
                  = link_to icon_edit + ' ' + 'Configurer', account_organization_addresses_path(@organization), class: 'btn btn-primary'
            #period_options.tab-pane{ class: ('active' if params[:tab] == 'period_options') }
              %table.table.table-condensed.table-striped
                %tbody
                  %tr
                    %th= t('mongoid.models.organization.attributes.authd_prev_period')
                    %td= @organization.authd_prev_period
                  %tr
                    %th= t('mongoid.models.organization.attributes.auth_prev_period_until_day')
                    %td= @organization.auth_prev_period_until_day
                  - if @user.is_admin
                    %tr
                      %th= t('mongoid.models.organization.attributes.auth_prev_period_until_month')
                      %td= @organization.auth_prev_period_until_month
              - if is_leader?
                .alignright
                  = link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_period_options_path(@organization), class: 'btn btn-primary'
                  - if @user.is_admin
                    = link_to icon_globe + ' Propager', select_propagation_options_account_organization_period_options_path(@organization), class: 'btn btn-primary'
            #knowings.tab-pane{ class: ('active' if params[:tab] == 'knowings') }
              - if @organization.knowings
                %table.table.table-condensed.table-striped
                  %tbody
                    %tr
                      %th= t('mongoid.models.knowings.attributes.is_active')
                      %td= @organization.knowings.is_active ? t('yes_value') : t('no_value')
                    %tr
                      %th= t('mongoid.models.knowings.attributes.state')
                      %td= Knowings.state_machine.states[@organization.knowings.state].human_name
                    %tr
                      %th= t('mongoid.models.knowings.attributes.url')
                      %td= @organization.knowings.url
                    %tr
                      %th= t('mongoid.models.knowings.attributes.pole_name')
                      %td= @organization.knowings.pole_name
                    %tr
                      %th= t('mongoid.models.knowings.attributes.is_third_party_included')
                      %td= @organization.knowings.is_third_party_included ? t('yes_value') : t('no_value')
              - if is_leader?
                - if @organization.knowings
                  .alignright
                    = link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_knowings_path(@organization), class: 'btn btn-primary'
                - else
                  .aligncenter
                    = link_to 'Configurer', new_account_organization_knowings_path(@organization), class: 'btn btn-primary'
            #ibiza.tab-pane{ class: ('active' if params[:tab] == 'ibiza') }
              %table.table.table-condensed.table-striped
                %tbody
                  %tr
                    %th= t('mongoid.models.ibiza.attributes.state')
                    %td
                      %span{ class: "label #{ibiza_state_label(@organization.ibiza)}" }= ibiza_state(@organization.ibiza)
                  %tr
                    %th= t('mongoid.models.ibiza.attributes.is_auto_deliver')
                    %td= @organization.ibiza.try(:is_auto_deliver) ? t('yes_value') : t('no_value')
              - if @organization.ibiza
                %h4.margin2top.margin1bottom Format de nom de la pièce iDocus dans iBiza (colonne Pièces dans iBiza)
                %table.table.table-condensed.table-striped
                  %thead
                    %tr
                      %th.name Valeur
                      %th.is_used Utilisé ?
                      %th.position Position
                  %tbody
                    %tr
                      %td.name Code complet
                      %td.is_used
                        - value = @organization.ibiza.piece_name_format['code']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.piece_name_format['code']['position'] rescue 1
                    %tr
                      %td.name Code dossier sans code cabinet
                      %td.is_used
                        - value = @organization.ibiza.piece_name_format['code_wp']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.piece_name_format['code_wp']['position'] rescue 1
                    %tr
                      %td.name Journal
                      %td.is_used
                        - value = @organization.ibiza.piece_name_format['journal']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.piece_name_format['journal']['position'] rescue 1
                    %tr
                      %td.name Période de traitement
                      %td.is_used
                        - value = @organization.ibiza.piece_name_format['period']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.piece_name_format['period']['position'] rescue 1
                    %tr
                      %td.name Numéro
                      %td.is_used
                        - value = @organization.ibiza.piece_name_format['number']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.piece_name_format['number']['position'] rescue 1
                %h4.margin2top.margin1bottom Format de l'écriture comptable dans iBiza
                %table.table.table-condensed.table-striped
                  %thead
                    %tr
                      %th.name Valeur
                      %th.is_used Utilisé ?
                      %th.position Position
                      %th
                  %tbody
                    %tr
                      %td.name Libellé de l'opération bancaire
                      %td.is_used= t('yes_value')
                      %td.position= @organization.ibiza.description['operation_label']['position'] rescue 1
                      %td Obligatoire pour une opération provenant d'un automate bancaire.
                    %tr
                      %td.name Date réelle
                      %td.is_used
                        - value = @organization.ibiza.description['date']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['date']['position'] rescue 1
                      %td
                    %tr
                      %td.name Tiers
                      %td.is_used
                        - value = @organization.ibiza.description['third_party']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['third_party']['position'] rescue 1
                      %td
                    %tr
                      %td.name Montant d'origine
                      %td.is_used
                        - value = @organization.ibiza.description['amount']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['amount']['position'] rescue 1
                      %td
                    %tr
                      %td.name Devise
                      %td.is_used
                        - value = @organization.ibiza.description['currency']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['currency']['position'] rescue 1
                      %td
                    %tr
                      %td.name Taux de conversion
                      %td.is_used
                        - value = @organization.ibiza.description['conversion_rate']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['conversion_rate']['position'] rescue 1
                      %td
                    %tr
                      %td.name Remarque
                      %td.is_used
                        - value = @organization.ibiza.description['observation']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['observation']['position'] rescue 1
                      %td
                    %tr
                      %td.name Journal
                      %td.is_used
                        - value = @organization.ibiza.description['journal']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['journal']['position'] rescue 1
                      %td
                    %tr
                      %td.name Nom de pièce (iDocus)
                      %td.is_used
                        - value = @organization.ibiza.description['piece_name']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['piece_name']['position'] rescue 1
                      %td
                    %tr
                      %td.name Référence pièce d'origine
                      %td.is_used
                        - value = @organization.ibiza.description['piece_number']['is_used'] rescue false
                        = value ? t('yes_value') : t('no_value')
                      %td.position= @organization.ibiza.description['piece_number']['position'] rescue 1
                      %td Permet d'afficher dans iBiza une référence dans la colonne Ref pièce (la colonne doit être affichée)
              - if is_leader?
                .alignright= link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_ibiza_path(@organization), class: 'btn btn-primary'
            #other_software.tab-pane{ class: ('active' if params[:tab] == 'other_software') }
              %table.table.table-condensed.table-striped
                %tbody
                  %tr
                    %th= t('mongoid.models.organization.attributes.is_quadratus_used')
                    %td= @organization.is_quadratus_used ? t('yes_value') : t('no_value')
                  %tr
                    %th= t('mongoid.models.organization.attributes.is_csv_descriptor_used')
                    %td= @organization.is_csv_descriptor_used ? t('yes_value') : t('no_value')
              - if is_leader?
                .alignright= link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_path(@organization, part: 'other_software'), class: 'btn btn-primary'
            - if @organization.ibiza.try(:is_configured?)
              #account_number_rules.tab-pane{ class: ('active' if params[:tab] == 'account_number_rules') }
                = link_to icon_new + ' Nouvelle ', new_account_organization_account_number_rule_path(@organization), class: 'btn btn-primary pull-right'
                %p
                  Les règles (#{@organization.account_number_rules.size}) ci-dessous s'appliquent aux opérations récupérées depuis les automates.
                %table.table.table-striped.table-condensed
                  %thead
                    %tr
                      %th= t('mongoid.models.account_number_rule.attributes.priority')
                      %th= t('mongoid.models.account_number_rule.attributes.name')
                      %th= t('mongoid.models.account_number_rule.attributes.affect')
                      %th= t('mongoid.models.account_number_rule.attributes.rule_type')
                      %th= t('mongoid.models.account_number_rule.attributes.content')
                      %th= t('mongoid.models.account_number_rule.attributes.third_party_account')
                  %tbody
                    - @organization.account_number_rules.asc(:priority).each do |rule|
                      %tr
                        %td= rule.priority
                        %td= rule.name
                        %td
                          = t('mongoid.models.account_number_rule.attributes.affect_values.' + rule.affect)
                          - if rule.affect == 'user'
                            (#{rule.users.size})
                        %td= t('mongoid.models.account_number_rule.attributes.rule_type_values.' + rule.rule_type)
                        %td= rule.content
                        %td= rule.third_party_account
                        %td
                          = link_to icon(icon: 'plus'), new_account_organization_account_number_rule_path(@organization, template: rule), class: 'btn btn-mini', title: 'Créer une règle en se basant sur cette règle'
                          = link_to icon_show, account_organization_account_number_rule_path(@organization, rule), class: 'btn btn-mini', title: 'Voir'
                          = link_to icon_edit, edit_account_organization_account_number_rule_path(@organization, rule), class: 'btn btn-mini', title: 'Editer'
                          = link_to icon_destroy, account_organization_account_number_rule_path(@organization, rule), class: 'btn btn-mini', method: :delete, data: { confirm: t('actions.confirm') }, title: 'Supprimer'
            #reminder_emails.tab-pane{ class: ('active' if params[:tab] == 'reminder_emails') }
              %p Configurez ici un nouvel e-mail de rappel qui sera envoyé à vos clients afin qu'ils n'oublient pas d'envoyer leurs documents.
              %table.table.table-striped.table-condensed
                %thead
                  %tr
                    %th= t('mongoid.models.reminder_email.attributes.name')
                    %th= t('mongoid.models.reminder_email.attributes.delivery_day')
                    %th= t('mongoid.models.reminder_email.attributes.delivered_at')
                    %th= t('mongoid.models.reminder_email.attributes.summarize')
                    %th= t('actions.name')
                %tbody
                  - @organization.reminder_emails.each do |reminder_email|
                    %tr
                      %td= reminder_email.name
                      %td
                        = reminder_email.delivery_day
                        = "(#{period_type reminder_email.period})"
                      %td= l(reminder_email.delivered_at) rescue ''
                      %td
                        = reminder_email.delivered_users.count
                        \/
                        = reminder_email.processed_users.count
                        \/
                        - if reminder_email.delivered_at
                          = @organization.customers.where(:created_at.lte => reminder_email.delivered_at).any_of({ inactive_at: nil }, { :inactive_at.gt => reminder_email.delivered_at }).count
                        - else
                          = @organization.customers.active.count
                      %td
                        = link_to icon(icon: 'plus'), new_account_organization_reminder_email_path(@organization, template: reminder_email), class: 'btn btn-mini', title: 'Configurer un nouveau e-mail de rappel en se basant sur cet e-mail'
                        = link_to icon_show, account_organization_reminder_email_path(@organization, reminder_email), class: 'btn btn-mini', target: :_blank, title: "Voir"
                        = link_to icon_edit, edit_account_organization_reminder_email_path(@organization, reminder_email), class: 'btn btn-mini', title: 'Editer'
                        = link_to icon_destroy, account_organization_reminder_email_path(@organization, reminder_email), class: 'btn btn-mini', method: :delete, data: { confirm: t('actions.confirm') }, title: 'Supprimer'
                        = link_to icon(icon: 'play') + ' ' + t('mongoid.models.reminder_email.actions.send'), deliver_account_organization_reminder_email_path(@organization, reminder_email), class: 'btn btn-mini', data: { confirm: t('mongoid.models.reminder_email.actions.send_confirmation') }, method: :post
              = link_to icon_new + ' ' + t('actions.new'), new_account_organization_reminder_email_path(@organization), class: 'btn btn-primary pull-right'
            #csv_descriptor.tab-pane{ class: ('active' if params[:tab] == 'csv_descriptor'), :style => "line-height:25px" }
              .aligncenter
                Créez un fichier d’export des écritures comptables en format .csv. Choisissez les différentes données que vous souhaitez récupérer en comptabilité.
                %br
                N.B.: ce fichier est nécessaire pour tous les outils comptables ne fonctionnant pas avec iDocus par API (Mode SaaS intégral).
                %br
                = link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_csv_descriptor_path(@organization), class: 'btn btn-primary'
            - if @user.is_admin
              #file_sending_kit.tab-pane{ class: ('active' if params[:tab] == 'file_sending_kit') }
                %table.table.table-striped.table-condensed
                  %tr
                    %th= t('mongoid.models.file_sending_kit.attributes.folders')
                    %td
                      - if File.exist? File.join(Rails.root, 'files', Rails.env, 'kit', 'folders.pdf')
                        = link_to 'folders.pdf', folders_account_organization_file_sending_kit_path(@organization), target: '_blank'
                  %tr
                    %th= t('mongoid.models.file_sending_kit.attributes.mails')
                    %td
                      - if File.exist? File.join(Rails.root, 'files', Rails.env, 'kit', 'mails.pdf')
                        = link_to 'mails.pdf', mails_account_organization_file_sending_kit_path(@organization), target: '_blank'
                  %tr
                    %th= t('mongoid.models.file_sending_kit.attributes.customer_labels')
                    %td
                      - if File.exist? File.join(Rails.root, 'files', Rails.env, 'kit', 'customer_labels.pdf')
                        = link_to 'customer_labels.pdf', customer_labels_account_organization_file_sending_kit_path(@organization), target: '_blank'
                  %tr
                    %th= t('mongoid.models.file_sending_kit.attributes.workshop_labels')
                    %td
                      - if File.exist? File.join(Rails.root, 'files', Rails.env, 'kit', 'workshop_labels.pdf')
                        = link_to 'workshop_labels.pdf', workshop_labels_account_organization_file_sending_kit_path(@organization), target: '_blank'
                .alignright
                  = link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_file_sending_kit_path(@organization), class: 'btn btn-primary'
                  = link_to icon(icon: 'ok-sign') + ' Générer', select_account_organization_file_sending_kit_path(@organization), class: 'btn btn-primary'
              #subscription.tab-pane{ class: ('active' if params[:tab] == 'subscription') }
                %table.table.table-striped.table-condensed
                  %tr
                    %th Option
                    %th Choix
                    %th.price Prix HT
                    %th.price Prix TTC
                  %tr
                    %td Clients
                    %td= @organization.customers.active_at(Time.now).count
                    %td.price= format_price_00(@total - @subscription.current_period.products_price_in_cents_wo_vat) + ' €'
                    %td.price= format_price_00((@total * @subscription.tva_ratio) - @subscription.current_period.products_price_in_cents_w_vat) + ' €'
                  - @subscription_options.each do |option|
                    %tr
                      %td= option.group_title
                      %td= option.title
                      %td.price= format_price_00(option.price_in_cents_wo_vat) + ' €'
                      %td.price= format_price_00(option.price_in_cents_wo_vat * @subscription.tva_ratio) + ' €'
                  %tr
                    %td
                    %th Total
                    %td.price= format_price_00(@total) + ' €'
                    %td.price= format_price_00(@total * @subscription.tva_ratio) + ' €'
                  %tr
                    %td
                    %th TVA (20 %)
                    %td
                    %td.price= format_price_00((@total * @subscription.tva_ratio) - @total) + ' €'
                .alignright
                  = link_to icon_edit + ' ' + t('actions.edit'), edit_account_organization_organization_subscription_path(@organization), class: 'btn btn-primary'
                  = link_to icon_edit + ' Propager les quotas', select_options_account_organization_organization_subscription_path(@organization), class: 'btn btn-primary'
