.block
  .secondary-navigation
    %ul.wat-cf
      %li.first.active!= link_to "All subscriptions", admin_subscriptions_path
      -#%li!= link_to "Add order", new_admin_subscription_path
  .content
    .inner
      - @order = @subscription.order
      %h2 Subscription ##{@subscription.number}
      %table.table
        %tr
          %th.first
          %th Datasheet
          %th
          %th.last
        %tr
          %td
          %td
            != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Created at', :value => l(@subscription.created_at)}
            != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Progress', :value => "#{@subscription.progress}/#{@subscription.end}"}
            - if @order
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'N° de commande associée', :value => (link_to @order.number, [:admin, @order])}
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Product', :value => @order.product_order.title}
            - else
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Prix de base en centime', :value => (@subscription.user.scanning_subscription.detail.base_price_in_cents rescue 0)}
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Nombre de feuilles compris', :value => (@subscription.user.scanning_subscription.detail.max_number_of_sheets rescue 0)}
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Nombre de pages téléversées compris', :value => (@subscription.user.scanning_subscription.detail.max_uploaded_pages rescue 0)}
          %td
            - if @order
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Updated at', :value => l(@subscription.updated_at)}
              - customer = @order.user rescue nil
              - if customer
                != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Customer', :value => link_to(@order.user.email, [:admin, @order.user])}
              - else
                != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Customer', :value => "Inconnu"}

              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'VAT RATIO', :value => @order.tva_ratio}
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Total without VAT', :value => format_price(@order.total_in_cents_wo_vat)}
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Total with VAT', :value => format_price(@order.total_in_cents_w_vat)}
              != render :partial =>'/admin/shared/show_field', :locals => {:key => 'Total VAT', :value => format_price(@order.total_vat)}
          %td
      %h3 Liste des options
      %table.table
        %tr
          %th.first
          %th Titre
          %th Prix
          %th Durée
          %th.last
        - if @order
          - @subscription.order.product_order.product_option_orders.each do |option|
            %tr
              %td
              %td!= option.group + " - " + option.title
              %td
                #{format_price option.price_in_cents_wo_vat} € HT
                %br
                %small
                  #{format_price(option.price_in_cents_wo_vat * 1.196)} € TTC
              %td!= option.duration
              %td
      %h3 Liste des documents
      %table.table
        %tr
          %th.first
          %th Date
          %th Nom
          %th Pièces
          %th Feuilles
          %th Page
          %th.last
        - total_sub_doc = 0
        - total_sheets = 0
        - total_pages = 0
        - if @order
          - @order.packs.order_by([:created_at,:asc]).each do |pack|
            - pack.get_division_from_pdf if pack.division.empty? || pack.division.nil?
            %tr{:class => cycle("odd", "even")}
              %td
              %td!=pack.created_at.strftime("%Y-%m-%d %H:%M")
              %td!=pack.name
              %td
                - res = pack.division[2].select{|d| d[1] == 2}.count
                - if res == 0
                  - res = pack.division[2].select{|d| d[1] == 1}.count
                !=res
              %td!=pack.division[2].select{|d| d[1] == 1}.count
              %td!=pack.division[1]
              %td
              - total_sub_doc += res
              - total_sheets += pack.division[2].select{|d| d[1] == 1}.count
              - total_pages += pack.division[1]
        %tr
          %td
          %td
          %td TOTAL
          %td!=total_sub_doc
          %td!=total_sheets
          %td!=total_pages
          %td
      
      .wat-cf
        != link_to image_tag("web-app-theme/application_edit.png", :alt => "Modifier") + "Modifier", edit_admin_subscription_path(@subscription), :class => "button"

- content_for :sidebar, render(:partial => 'sidebar')